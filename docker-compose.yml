version: '3.8'

services:
  # Servicio principal que ejecuta API + Streamlit
  alzheimer-prediction-system:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: alzheimer-prediction-system
    
    # Puertos expuestos
    ports:
      - "8000:8000"    # API FastAPI
      - "8501:8501"    # Streamlit UI - Predicción
      - "8502:8502"    # Streamlit UI - Reporte de Drift
    
    # Variables de entorno
    environment:
      - PYTHONUNBUFFERED=1
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    
    # Volúmenes (opcional para desarrollo)
    volumes:
      # Solo lectura para artefactos (seguridad)
      - ./mlops_pipeline/artifacts:/app/artifacts:ro
      # Para resultados de monitoreo
      - ./mlops_pipeline/monitoring_results:/app/monitoring_results
      # Para datos procesados (drift monitoring)
      - ./mlops_pipeline/data:/app/data:ro
    
    # Política de reinicio
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logs
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # Limites de recursos (opcional)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '1'
    #       memory: 1G

# Volúmenes nombrados
volumes:
  artifacts:
  monitoring_results:

# Red personalizada
networks:
  default:
    name: alzheimer-network
    driver: bridge
